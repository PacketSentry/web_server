{% extends "base.html" %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="row">
    <div class="col-md-4">
        <div class="card p-3 mb-3 shadow-sm">
            <h4>Client Status</h4>
            <div id="status-alert" class="alert alert-secondary py-2" style="min-height: 50px; display: flex; align-items: center;">
                Loading...
            </div>
            <p class="mb-1"><strong>Top App:</strong> <span id="top-app">---</span></p>
            <p class="mb-1"><strong>Download:</strong> <span id="total-down" class="text-success">0.00 Mbps</span></p>
            <p class="mb-1"><strong>Upload:</strong> <span id="total-up" class="text-primary">0.00 Mbps</span></p>
        </div>

        <div class="card p-3 mb-3 shadow-sm">
            <h4>Traffic Distribution</h4>
            <div style="height: 250px; position: relative;">
                <canvas id="trafficChart"></canvas>
            </div>
        </div>
    </div>

    <div class="col-md-8">
        <div class="card p-3 mb-3 shadow-sm" style="max-height: 550px; overflow-y: auto;">
            <h4>Active Applications</h4>
            <table class="table table-sm table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Application</th>
                        <th>Down (Mbps)</th>
                        <th>Up (Mbps)</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="app-list-body">
                    </tbody>
            </table>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card p-3 shadow-sm">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0">Traffic History (Last 20)</h4>
                <a href="/api/export-csv" target="_blank" class="btn btn-outline-primary">
                    ðŸ“¥ Export Full CSV
                </a>
            </div>
            <div class="table-responsive">
                <table class="table table-bordered table-striped">
                    <thead class="table-dark">
                        <tr>
                            <th>Time</th>
                            <th>Application</th>
                            <th>Size (Bytes)</th>
                            <th>Direction</th>
                            <th>Remote IP</th>
                        </tr>
                    </thead>
                    <tbody id="logs-body">
                        </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // --- KILL APP FUNCTION ---
    async function killApp(appName) {
        if (!confirm("Are you sure you want to KILL " + appName + "?\nThis will stop the process on the remote machine.")) return;
        
        try {
            const res = await fetch('/api/kill-app', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ app_name: appName })
            });
            
            if (res.ok) {
                alert("Kill command sent for " + appName + ".");
            } else {
                alert("Failed to send command.");
            }
        } catch (e) {
            alert("Error: " + e);
        }
    }

    // --- Chart Logic ---
    const ctx = document.getElementById('trafficChart').getContext('2d');
    const trafficChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: ['Download', 'Upload'],
            datasets: [{
                data: [1, 1], 
                backgroundColor: ['#198754', '#0d6efd'], 
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false, 
            plugins: { legend: { position: 'bottom' } }
        }
    });

    // --- Dynamic Update ---
    async function updateDashboard() {
        try {
            const response = await fetch('/api/dashboard-data');
            if (response.status === 401) { window.location.href = "/"; return; }
            const data = await response.json();

            // Status
            const alertBox = document.getElementById('status-alert');
            if (data.is_online) {
                alertBox.className = "alert alert-success py-2";
                alertBox.textContent = "âœ… Client Online";
            } else {
                alertBox.className = "alert alert-danger py-2";
                alertBox.textContent = "âŒ Client Offline";
            }
            
            document.getElementById('top-app').textContent = data.top_app;
            let downMbps = (data.current_down * 8) / 1024;
            let upMbps = (data.current_up * 8) / 1024;
            document.getElementById('total-down').textContent = downMbps.toFixed(2) + " Mbps";
            document.getElementById('total-up').textContent = upMbps.toFixed(2) + " Mbps";

            // Chart
            if (downMbps === 0 && upMbps === 0) {
                trafficChart.data.datasets[0].data = [0.1, 0.1]; 
                trafficChart.data.datasets[0].backgroundColor = ['#e9ecef', '#e9ecef']; 
            } else {
                trafficChart.data.datasets[0].data = [downMbps, upMbps];
                trafficChart.data.datasets[0].backgroundColor = ['#198754', '#0d6efd']; 
            }
            trafficChart.update();

            // App List
            const appBody = document.getElementById('app-list-body');
            appBody.innerHTML = ""; 
            if (data.app_list && data.app_list.length > 0) {
                data.app_list.forEach(app => {
                    const row = document.createElement('tr');
                    let appDown = (app.down * 8) / 1024;
                    let appUp = (app.up * 8) / 1024;
                    let downClass = appDown > 0 ? "fw-bold text-success" : "text-muted";
                    let upClass = appUp > 0 ? "fw-bold text-primary" : "text-muted";
                    
                    row.innerHTML = `
                        <td>${app.name}</td>
                        <td class="${downClass}">${appDown.toFixed(2)}</td>
                        <td class="${upClass}">${appUp.toFixed(2)}</td>
                        <td>
                            <button class="btn btn-sm btn-danger" onclick="killApp('${app.name}')">Kill</button>
                        </td>
                    `;
                    appBody.appendChild(row);
                });
            } else {
                appBody.innerHTML = `<tr><td colspan="4" class="text-center text-muted">No active applications.</td></tr>`;
            }

            // Logs
            const logsBody = document.getElementById('logs-body');
            logsBody.innerHTML = "";
            if (data.logs && data.logs.length > 0) {
                data.logs.forEach(log => {
                    const row = document.createElement('tr');
                    let dirBadge = log.direction === 'Incoming' 
                        ? '<span class="badge bg-success">Incoming</span>' 
                        : '<span class="badge bg-primary">Outgoing</span>';

                    row.innerHTML = `
                        <td>${log.timestamp}</td>
                        <td>${log.app_name}</td>
                        <td>${log.packet_size}</td>
                        <td>${dirBadge}</td>
                        <td class="font-monospace">${log.ip_address}</td>
                    `;
                    logsBody.appendChild(row);
                });
            } else {
                logsBody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">No history found.</td></tr>`;
            }

        } catch (error) { console.error(error); }
    }
    updateDashboard();
    setInterval(updateDashboard, 2000);
</script>
{% endblock %}